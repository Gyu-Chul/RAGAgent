# **Vector DB 통합 서비스 (Vector DB Service)**

이 도구는 Python 소스 코드를 벡터(Vector)로 변환하여 Milvus 벡터 데이터베이스에 저장하고, 하이브리드 검색(Hybrid Search) 기능을 제공하는 통합 서비스입니다. 전체 소스 코드 블럭을 대상으로 의미적으로 유사한, 그리고 특정 키워드가 포함된 코드를 정확하게 찾아내는 코드 검색 및 분석 기능을 제공합니다.

## **핵심 기술 및 아키텍처**


### **하이브리드 검색 (Hybrid Search) 이란?**

하이브리드 검색은 두 가지 검색 방식의 장점을 결합한 기술입니다.

1. **의미 검색 (Semantic Search \- Dense Vector)**  
   * **기술**: HuggingFace의 최신 언어 모델을 사용하여 코드의 '의미'와 '문맥'을 이해하고, 이를 고차원 벡터(Dense Vector)로 변환합니다.   

2. **키워드 검색 (Keyword Search \- Sparse Vector)**  
   * **기술**: 전통적인 정보 검색 알고리즘인 BM25를 사용하여 코드 내의 '키워드' 출현 빈도와 중요도를 계산하고, 이를 희소 벡터(Sparse Vector)로 표현합니다.    

### **RRF (Reciprocal Rank Fusion) 랭킹**

두 검색 엔진(의미, 키워드)이 각각 반환한 결과 목록은 **RRF (역순위 가중치 융합)** 알고리즘을 통해 재정렬됩니다. RRF는 각 검색 결과의 순위를 기반으로 최종 점수를 매겨, 두 방식 모두에서 중요하다고 판단되는 결과를 최상단으로 올려주는 역할을 합니다. 이를 통해 검색 결과의 전반적인 품질이 크게 향상됩니다.
<br>
<br>
<br>
## **주요 기능 및 구성 요소**


### **1\. CollectionManager: Milvus 컬렉션 관리자**

* **역할**: 벡터 데이터가 저장될 공간인 Milvus Collection을 생성, 삭제, 조회하는 등 생명주기 전체를 관리합니다.  
* **주요 기능**:  
  * **최적화된 스키마**: 하이브리드 검색에 최적화된 필드(dense, sparse 벡터, 메타데이터 등)를 포함하는 컬렉션 스키마를 정의합니다.  
  * **인덱스 자동 생성**: 벡터 검색 성능을 극대화하기 위해 HNSW(Dense), SPARSE\_WAND(Sparse) 등 각 필드에 최적화된 인덱스를 생성합니다.

### **2\. EmbeddingService & RepositoryEmbedder: 임베딩 파이프라인**

* **역할**: 파싱된 코드 청크(JSON 데이터)를 입력받아, 이를 Milvus에 저장할 수 있는 벡터와 메타데이터로 변환하는 전체 과정을 담당합니다.  
* **주요 기능**:  
  * **Dual-Embedding**: 하나의 코드 조각에 대해 Dense Vector와 Sparse Vector를 동시에 생성합니다.  
  * **배치 처리**: 대규모 데이터를 처리할 때 메모리 부족 문제를 방지하기 위해, 임베딩 생성과 DB 삽입 과정을 작은 배치(Batch) 단위로 나누어 안정적으로 수행합니다.  
  * **BM25 모델 캐싱**: 컬렉션별로 생성된 BM25 모델을 메모리에 캐싱하여, 매번 새로 계산할 필요 없이 검색 시 빠르게 재사용합니다.

### **3\. SearchService: 하이브리드 검색 엔진**

* **역할**: 사용자 쿼리를 받아 하이브리드 검색을 수행하고 최종 결과를 반환하는 핵심 검색 로직을 담당합니다.  
* **주요 기능**:  
  * **쿼리 변환**: 사용자 쿼리 역시 Dense/Sparse 벡터로 변환하여 검색에 사용합니다.  
  * **동적 BM25 모델 생성**: 만약 캐시된 BM25 모델이 없다면, DB에서 데이터를 가져와 검색 시점에 동적으로 모델을 생성하여 희소 벡터 검색을 가능하게 합니다.  
  * **RRF 랭킹 적용**: Milvus의 hybrid\_search 기능과 RRFRanker를 활용하여 두 검색 결과를 융합하고 최종 순위를 결정합니다.

### **4\. VectorDBService: 통합 서비스 인터페이스 🔗**

* **역할**: 위 모든 구성 요소를 하나로 묶어, 개발자가 단일 진입점(Single Entry Point)을 통해 모든 기능을 쉽게 사용할 수 있도록 추상화된 API를 제공합니다.

## **동작 과정 (Workflow)**

1. **(준비)** Git Service와 Parser를 통해 분석할 Git 저장소의 코드들이 parsed\_repository/{repo\_name} 폴더에 JSON 파일들로 준비됩니다.  
2. **(임베딩)** VectorDBService.embed\_repository()를 호출합니다.  
   * 서비스는 parsed\_repository 내의 모든 JSON 파일을 하나로 병합합니다.  
   * 각 코드 청크에 대해 **Dense/Sparse 벡터를 모두 생성**합니다.  
   * 생성된 벡터와 메타데이터를 Milvus 컬렉션에 **배치 단위로 삽입**합니다.  
   * 이 과정에서 생성된 BM25 모델은 캐시에 저장됩니다.  
3. **(검색)** VectorDBService.search()를 호출합니다.  
   * 사용자 쿼리를 **Dense/Sparse 벡터로 변환**합니다.  
   * 두 쿼리 벡터를 사용하여 Milvus에 **하이브리드 검색을 요청**합니다.  
   * Milvus는 내부적으로 두 검색 결과를 **RRF로 재정렬**하여 최종 결과를 반환합니다.  
   * 서비스는 결과를 사용하기 쉬운 형태로 가공하여 사용자에게 전달합니다.

